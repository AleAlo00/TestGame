{% extends "master.html" %}

{% block title %}
Details about {{ myphone.name }}
{% endblock %}

{% block content %}
<div class="container">
  <div class="box">
    <h1>{{ myphone.name }}</h1>

    <p>ID: {{ myphone.id }}</p>
    <p>Date: {{ myphone.date }}</p>

    <ul id="characteristics-list">
      {% for key, value in myphone.characteristics.items %}
      <li>{{ key }}: {{ value }}</li>
      {% endfor %}
    </ul>

    <form action="{% url 'add_specific' phone_id=myphone.id %}" method="POST">
      {% csrf_token %}
      <label for="characteristic">Choose a characteristic:</label>
      <select name="characteristic" id="characteristic">
        <option value>Select a characteristic</option>
        {% for key in default_characteristics.keys %}
        {% if key not in myphone.characteristics %}
        <option value="{{ key }}">{{ key }}</option>
        {% endif %}
        {% endfor %}
      </select>

      <label for="specific">Choose a specific:</label>
      <select name="specific" id="specific">
        <option value>Select a specific</option>
      </select>

      <button type="submit">Add Specific</button>
    </form>

    <p><a href="/phone">Back to Phone</a></p>
  </div>
  <div class="box">
    <div id="phone-image">
      <div id="phone-screen">
        <!-- Il logo verrà visualizzato al centro dello schermo -->
        <div id="phone-logo" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
          <img id="logo-img" src="" alt="Phone Brand" style="max-width: 100px; max-height: 100px;">
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Recupera il colore dal localStorage o dalle caratteristiche del telefono
  let currentColor;

  // Controlla se il colore è presente nel localStorage per questo telefono
  const phoneId = {{ myphone.id|safe }}; // Usa l'ID del telefono come chiave unica
  const storedColor = localStorage.getItem(`phoneColor_${phoneId}`);

  if (storedColor) {
    currentColor = storedColor; // Colore salvato in precedenza
  } else if ("Color" in {{ myphone.characteristics|safe }} && "{{ myphone.characteristics.Color|default:'' }}") {
    currentColor = "{{ myphone.characteristics.Color|default:'' }}".toLowerCase(); // Colore dalla caratteristica
  } else {
    currentColor = "gray"; // Colore di default
  }

  // Imposta il colore iniziale del telefono
  const phoneImage = document.getElementById("phone-image");
  phoneImage.style.backgroundColor = currentColor;

  // Recupera gli elementi del DOM per caratteristiche e specifiche
  const characteristics = {{ default_characteristics|safe }};
  const characteristicSelect = document.getElementById("characteristic");
  const specificSelect = document.getElementById("specific");

  // Aggiungi una mappa dei loghi
  const logoMap = {
    "Samsung": "/static/logos/samsung.png",
    "Apple": "/static/logos/apple.png",
    "Huawei": "/static/logos/huawei.png",
    "Xiaomi": "/static/logos/xiaomi.png",
    "Oppo": "/static/logos/oppo.png"
  };

  // Aggiorna la visualizzazione del logo in base al brand
  const logoImg = document.getElementById("logo-img");

  // Inizializza il logo del brand
  function updateLogo(brand) {
    if (brand && logoMap[brand]) {
      logoImg.src = logoMap[brand]; // Aggiorna il logo con il path dell'immagine
    } else {
      logoImg.src = ""; // Nessun logo disponibile
    }
  }

  // Mostra il logo del brand iniziale
  const initialBrand = "{{ myphone.characteristics.Brand|default:'' }}";
  updateLogo(initialBrand);

  // Aggiorna le opzioni specifiche in base alla caratteristica selezionata
  characteristicSelect.addEventListener("change", function () {
    const selectedCharacteristic = characteristicSelect.value;

    // Pulisce la lista delle specifiche
    specificSelect.innerHTML = '<option value="">Select a specific</option>';

    if (selectedCharacteristic && characteristics[selectedCharacteristic]) {
      const specifics = characteristics[selectedCharacteristic];
      specifics.forEach(function (spec) {
        const option = document.createElement("option");
        option.value = spec;
        option.textContent = spec;
        specificSelect.appendChild(option);
      });
    }
  });

  // Gestisce la modifica delle specifiche
  specificSelect.addEventListener("change", function () {
    const selectedSpecific = specificSelect.value;

    if (selectedSpecific && characteristicSelect.value === "Color") {
      const color = selectedSpecific.toLowerCase(); // Colore scelto
      phoneImage.style.backgroundColor = color; // Aggiorna il colore in tempo reale
      localStorage.setItem(`phoneColor_${phoneId}`, color); // Salva il colore nel localStorage con l'ID del telefono
      currentColor = color; // Aggiorna la variabile del colore attuale
    } else {
      // Mantieni il colore attuale se la specifica non è il colore
      phoneImage.style.backgroundColor = currentColor;
    }

    // Aggiorna il logo se la specifica riguarda il brand
    if (selectedSpecific && characteristicSelect.value === "Brand") {
      const brand = selectedSpecific; // Brand scelto
      updateLogo(brand); // Modifica il logo del brand
    }
  });

</script>

{% endblock %}
